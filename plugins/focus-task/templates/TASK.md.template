status: pending
<!-- ↑ Line 1 status: stop hook reads this. MUST match table Status. Values: pending|in progress|handoff|finished -->

# Task: {NAME}

> **AUTONOMY:** Work until DONE. Iterate until all criteria met.
> **CONTEXT:** Load per phase via ID. KNOWLEDGE.jsonl holds accumulated knowledge.

## Meta

| Created | {TIMESTAMP} | Status | pending |
|---------|-------------|--------|---------|
| Spec | `.claude/tasks/specs/{TIMESTAMP}_{NAME}_SPEC_v1.md` |||
| Knowledge | `.claude/tasks/{TIMESTAMP}_{NAME}_KNOWLEDGE.jsonl` |||

## Reports

| Field | Path |
|-------|------|
| Report Dir | `.claude/tasks/reports/{TIMESTAMP}_{NAME}/` |
| Manifest | `.claude/tasks/reports/{TIMESTAMP}_{NAME}/MANIFEST.md` |
| Final | `.claude/tasks/reports/{TIMESTAMP}_{NAME}/FINAL.md` |

> **Report Structure:** `reports/{TIMESTAMP}_{NAME}/phase_{P}/iter_{N}_{type}/`
> - `{type}`: `exec` (execution) or `verify` (verification)
> - Each iteration contains: `{AGENT}_output.md`, `summary.md`, optional `{AGENT}_artifacts/`

**Statuses:** `pending` → `in progress` → `handoff` → `finished`

## KNOWLEDGE Protocol

> Coordinator extracts knowledge from agent reports (Manager writes reports first).

**Schema (one JSON per line):**
```jsonl
{"ts":"2026-01-28T14:00:00","cat":"db","t":"❌","txt":"Do not use SELECT * in production queries","src":"developer"}
```

| Field | Values |
|-------|--------|
| `ts` | ISO8601 timestamp |
| `cat` | `docker` `db` `api` `test` `config` `security` `performance` `arch` `code` |
| `t` | `❌` avoid/pitfall, `✅` best practice, `ℹ️` info/fact |
| `txt` | One specific, actionable sentence — unique discovery |
| `src` | Agent name (lowercase) |

**GOOD entries (granular, unique discoveries):**
- `{"t":"❌","txt":"DBRider @DataSet does not support JSONB columns — use @Sql instead","src":"tester"}`
- `{"t":"✅","txt":"Use @Sql annotation for test data with JSONB columns","src":"developer"}`

**BAD entries (NEVER write these):**
- `{"type":"✅","phase":1,"content":"Phase 1 complete: 18 loads consolidated"}` — wrong schema + phase summary
- `{"t":"ℹ️","txt":"Task completed successfully","src":"manager"}` — trivial, not a discovery

## Completion Criteria

- [ ] {CRITERION_1}
- [ ] {CRITERION_2}

## Agents

> **Priority:** Project Agents > Core Agents. Run `/focus-task:setup` to populate.

### Project Agents
<!-- TBD: Populated by /focus-task:setup from .claude/agents/ -->

| Agent | Purpose | Model |
|-------|---------|-------|
| TBD | TBD | TBD |

### Core Agents

| Agent | Purpose | Model |
|-------|---------|-------|
| `developer` | Code implementation | sonnet |
| `tester` | Tests, analysis | sonnet |
| `reviewer` | Quality, security, patterns | sonnet |
| `Explore` | Codebase search (READ-ONLY) | haiku |
| `ft-coordinator` | Update TASK.md, validate | sonnet |

## Reference Examples

> Эталонные файлы. Agents MUST read and follow patterns.

| ID | Type | File |
|----|------|------|
| R1 | {TYPE} | {PATH} |
| R2 | {TYPE} | {PATH} |

## Context Index

> Task-specific files. Reference by ID in phase Context field.

| ID | File | Purpose |
|----|------|---------|
| C1 | {PATH} | {WHY} |
| C2 | {PATH} | {WHY} |

---

## Phases

> **Rules:**
> - Manager decides phase count and sequence based on task complexity
> - Each phase = Execution → Verification (V)
> - Pass `Context` + `Refs` IDs to agents (they read files themselves)
> - V-phase: 2+ agents parallel, one checks quality, one checks project patterns
>
> **Iteration Protocol:**
> ```
> WHILE Phase NV has Issues:
>   1. Fix issues (developer/tester)
>   2. RE-RUN Phase NV (MANDATORY - same agents verify again!)
>   3. Pass? → proceed | Fail? → iter++ → repeat 1-2
>   4. Max 3 iterations → escalate
> ```
>
> **CRITICAL:** NEVER mark phase complete after fix without re-verification!
>
> **MANDATORY POST-AGENT** (after EVERY work agent completes):
> ⛔ Complete BOTH steps IN ORDER before calling next agent:
> 1. WRITE REPORT: Save agent output (+ your supplements/aggregation) → `reports/.../phase_P/iter_N_type/{AGENT}_output.md`
> 2. CALL COORDINATOR: `ft-coordinator` reads report → extracts knowledge → updates status + MANIFEST
> DO NOT proceed to next agent or phase until BOTH steps complete.
>
> **Examples:** Repository impl → Repository tests → DDL → Pattern analysis → Controller → Integration tests

---

### Phase 1: {DESCRIPTION}

| Agent | {AGENT} | Status | pending | Context | C1 | Refs | R1 |
|-------|---------|--------|---------|---------|----|----- |----|

**Tasks:** {TASK_LIST}

**Exit:** {CRITERIA} | **Result:** -

---

### Phase 1V: Verification

> Manager picks 2+ agents based on phase type. For tests: use `tester` instead of `developer`.

| Agent | Focus | Context | Refs |
|-------|-------|---------|------|
| `reviewer` | Logic, edge cases, security | C1 | - |
| `developer` | Project patterns compliance | C1 | R1 |
| `tester` | Test strictness: assertions, test data, expected values | C1 | R1 |
| TBD | Project-specific checks (from Project Agents) | C1 | R1 |

<!--
  Code phase: reviewer + developer + [project agent]
  Test phase: reviewer + tester + [project agent]
  Pick most relevant for phase type
-->

**Check:** [ ] Criteria met [ ] No regressions [ ] Patterns followed

**Status:** pending | **Issues:** -

---

<!-- Add Phase 2, 2V, 3, 3V... as needed -->

---

## Final Review

> **Parallel:** 3+ agents. Manager picks from Core + Project Agents based on task type.

| Agent | Focus | Against |
|-------|-------|---------|
| `reviewer` | Requirements, logic | Completion Criteria |
| `developer` | Code quality, SOLID | Reference Examples |
| `tester` | Test quality, strictness | Reference Examples |
| TBD | Project-specific (db_expert, etc.) | Reference Examples |

<!-- TBD: /focus-task:setup adds project-specific agents here -->

**Flow:** All pass → DONE | Issues → fix → re-review

**Status:** pending

---

## Failure Protocol

```
Phase NV fails 3x → ESCALATE
```

| # | Action | When |
|---|--------|------|
| 1 | **R&D Phase** | Root cause unclear → Add Phase NR: Explore + reviewer → KNOWLEDGE |
| 2 | **Split Phase** | Scope too large → Break into N.a, N.b, N.c |
| 3 | **Agent Upgrade** | Complexity → sonnet → opus |
| 4 | **Reassign** | Wrong agent type → switch agent |
| 5 | **AskUserQuestion** | LAST RESORT: requires 2+ agents agree + 10+ iterations total |

**Flow:** Escalate → try 1-4 → max 2 escalations per phase → option 5 only with quorum

## Manager Actions

⛔ After EACH agent: WRITE REPORT → CALL COORDINATOR. See Phases rules.

---

**Status:** PENDING | **Iteration:** 0
