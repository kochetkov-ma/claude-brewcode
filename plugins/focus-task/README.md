# Focus Task Plugin

## Overview

Infinite task execution with automatic session handoff for Claude Code. Enables complex, multi-phase tasks that exceed single-session context limits.

## Installation

```bash
claude --plugin-dir plugins/focus-task
```

## Skills

| Skill | Description |
|-------|-------------|
| `/focus-task:adapt` | Analyzes project structure, creates adapted templates in `.claude/tasks/templates/` |
| `/focus-task:create <desc>` | Creates TASK.md, SPEC.md, KNOWLEDGE.jsonl through parallel agent research |
| `/focus-task:start [path]` | Executes task with SDK runtime, handles automatic handoff at 90% context |
| `/focus-task:review [prompt]` | Multi-agent code review with quorum consensus (default: 3 agents, 2/3 quorum) |
| `/focus-task:rules [path]` | Extracts rules from KNOWLEDGE.jsonl to `.claude/rules/avoid.md` and `best-practice.md` |
| `/focus-task:doc [mode]` | Creates/updates project documentation through parallel codebase analysis |

## Directory Structure

### Plugin Location (this repo)

```
plugins/focus-task/
├── .claude-plugin/plugin.json
├── skills/                    # 6 skills
│   ├── focus-task-adapt/
│   ├── focus-task-create/
│   ├── focus-task-doc/
│   ├── focus-task-review/
│   ├── focus-task-rules/
│   └── focus-task-start/
├── agents/                    # 2 agents
│   ├── ft-coordinator.md
│   └── ft-knowledge-manager.md
├── templates/                 # Base templates
│   ├── TASK.md.template
│   ├── SPEC.md.template
│   ├── KNOWLEDGE.jsonl.template
│   ├── rules/
│   └── reports/
├── hooks/
└── runtime/                   # TypeScript SDK runtime
```

### Target Project (where plugin is used)

```
{PROJECT}/
└── .claude/
    ├── TASK.md                          # Pointer to active task
    ├── tasks/
    │   ├── {TS}_{NAME}_TASK.md          # Task file
    │   ├── {TS}_{NAME}_KNOWLEDGE.jsonl  # Accumulated knowledge
    │   ├── specs/
    │   │   └── {TS}_{NAME}_SPEC_vN.md   # Task specifications
    │   ├── templates/                   # Created by /focus-task:adapt
    │   │   ├── TASK.md.template
    │   │   └── SPEC.md.template
    │   ├── reports/                     # Execution reports
    │   │   └── {TS}_{NAME}/
    │   │       ├── MANIFEST.md
    │   │       ├── FINAL.md
    │   │       └── phase_N/
    │   ├── reviews/                     # Code review reports
    │   └── cfg/
    │       ├── focus-task.config.json   # Optional project config
    │       └── .focus-task.lock         # Lock file during execution
    └── rules/                           # Generated by /focus-task:rules
        ├── avoid.md
        └── best-practice.md
```

## Workflow

1. **Adapt templates** (once per project):
   ```
   /focus-task:adapt
   ```

2. **Create task**:
   ```
   /focus-task:create "Implement user authentication with JWT"
   ```

3. **Execute task**:
   ```
   /focus-task:start .claude/tasks/20260126_150000_auth_TASK.md
   ```

4. **Review code** (optional):
   ```
   /focus-task:review "Check null safety and security"
   ```

5. **Extract rules** (optional):
   ```
   /focus-task:rules .claude/tasks/20260126_150000_auth_KNOWLEDGE.jsonl
   ```

## Agents

| Agent | Purpose |
|-------|---------|
| `ft-coordinator` | Updates task status, writes reports, validates progress, manages MANIFEST.md |
| `ft-knowledge-manager` | Compacts KNOWLEDGE.jsonl, deduplicates entries, prioritizes by type |

## Reports System

Task execution generates structured reports in `.claude/tasks/reports/{TS}_{NAME}/`:

```
reports/{TS}_{NAME}/
├── MANIFEST.md              # Index of all phases/iterations
├── FINAL.md                 # Generated on task completion
└── phase_{P}/
    ├── iter_{N}_exec/       # Execution iteration
    │   ├── {AGENT}_output.md
    │   └── summary.md
    └── iter_{N}_verify/     # Verification iteration
        ├── {AGENT}_review.md
        ├── issues.jsonl
        └── summary.md
```

The `ft-coordinator` agent manages reports:
- Creates report directories before each phase
- Writes agent outputs after completion
- Updates MANIFEST.md with phase status
- Generates FINAL.md on task completion

## KNOWLEDGE.jsonl Format

```jsonl
{"ts":"2026-01-26T14:00:00","cat":"db","t":"❌","txt":"Do not use SELECT *","src":"sql_expert"}
{"ts":"2026-01-26T14:05:00","cat":"api","t":"✅","txt":"Use @Valid for DTOs","src":"developer"}
```

Types (priority order): `❌` (avoid) > `✅` (best practice) > `ℹ️` (info)

## Handoff Protocol

When context reaches 90%:

1. `ft-coordinator` saves current state, finalizes iteration reports
2. Coordinator adds handoff entry to MANIFEST.md
3. `ft-knowledge-manager` compacts KNOWLEDGE.jsonl
4. SDK Runtime creates new Claude session automatically
5. New session loads task file + KNOWLEDGE.jsonl + MANIFEST.md
6. Execution continues from current phase seamlessly

## Configuration

Configuration files (highest priority first):

1. `{PROJECT}/.claude/tasks/cfg/focus-task.config.json`
2. `~/.claude/tasks/cfg/focus-task.config.json`
3. Built-in defaults

```json
{
  "contextThreshold": 0.9,
  "warningThreshold": 0.85,
  "maxTokens": 200000,
  "knowledgeLimit": 50
}
```

## License

MIT
