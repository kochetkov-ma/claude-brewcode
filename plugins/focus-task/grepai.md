# grepai Integration

> Semantic code search с автоматическим фокусированием внимания ИИ на grepai вместо стандартных утилит.

**See also:** [README.md](README.md) | [INSTALL.md](INSTALL.md) | [ft-grepai-configurator](agents/ft-grepai-configurator.md) | [/focus-task:grepai](skills/grepai/SKILL.md)

## Overview

grepai — семантический поиск по коду через embeddings. Интегрирован в focus-task plugin через MCP (Model Context Protocol) с системой принудительного фокусирования внимания ИИ.

```
┌────────────────────────────────────────────────────────────────────────────┐
│                          grepai ECOSYSTEM                                   │
├────────────────────────────────────────────────────────────────────────────┤
│  Infrastructure        Skills/Agents           Attention System            │
│  ──────────────        ─────────────           ────────────────            │
│  • Ollama (bge-m3)     • /focus-task:grepai    • 3 hooks                   │
│  • grepai CLI          • ft-grepai-configurator • 1 rule template          │
│  • MCP Server          • 11 shell scripts      • CLAUDE.md injection       │
│  • .grepai/ dir        • config.yaml.example   • Unified reminder message  │
└────────────────────────────────────────────────────────────────────────────┘
```

## Architecture

```
                          ┌─────────────────────────┐
                          │     Claude Code CLI     │
                          └───────────┬─────────────┘
                                      │
           ┌──────────────────────────┼──────────────────────────┐
           │                          │                          │
           ▼                          ▼                          ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│   SessionStart      │   │   PreToolUse:Task   │   │  PreToolUse:Glob    │
│   ───────────────   │   │   ───────────────   │   │  PreToolUse:Grep    │
│   grepai-session.mjs│   │   pre-task.mjs      │   │  ──────────────     │
│                     │   │                     │   │  grepai-reminder.mjs│
│   • Auto-start      │   │   • Inject reminder │   │                     │
│   • Health check    │   │   • Modify prompt   │   │   • Remind about    │
│   • Status report   │   │   • ALL agents      │   │     grepai option   │
└──────────┬──────────┘   └──────────┬──────────┘   └──────────┬──────────┘
           │                          │                          │
           └──────────────────────────┼──────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────┐
                    │      Unified Reminder Message    │
                    │                                 │
                    │  "grepai: USE grepai_search     │
                    │   FIRST for code exploration"   │
                    └─────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
            ┌───────────┐     ┌───────────┐     ┌───────────┐
            │ Explore   │     │ developer │     │ tester    │
            │ Plan      │     │ reviewer  │     │ custom    │
            │ Bash      │     │ ...       │     │ agents    │
            └───────────┘     └───────────┘     └───────────┘
```

## Directory Structure

```
{PROJECT}/
├── .grepai/                        # grepai configuration (created by setup)
│   ├── config.yaml                 # Generated by ft-grepai-configurator
│   ├── config.yaml.backup          # Created during optimize
│   ├── index.gob                   # Vector embeddings (created by watch)
│   ├── symbols.gob                 # Call graph data
│   └── logs/
│       └── grepai-watch.log        # Daemon log
│
├── .claude/
│   ├── rules/
│   │   └── grepai-first.md         # Attention-forcing rule
│   └── tasks/logs/
│       └── grepai.log              # Hook diagnostic log
│
└── CLAUDE.md                       # Contains "CRITICAL: Use grepai_search FIRST"

plugins/focus-task/
├── skills/grepai/
│   ├── SKILL.md                    # Main skill definition
│   ├── config.yaml.example         # Config template
│   └── scripts/                    # 11 bash scripts
│       ├── detect-mode.sh
│       ├── infra-check.sh
│       ├── mcp-check.sh
│       ├── init-index.sh
│       ├── start.sh
│       ├── stop.sh
│       ├── reindex.sh
│       ├── optimize.sh
│       ├── upgrade.sh
│       ├── status.sh
│       ├── verify.sh
│       └── create-rule.sh
│
├── agents/
│   └── ft-grepai-configurator.md   # Opus agent for config generation
│
├── templates/rules/
│   └── grepai-first.md.template    # Rule template
│
└── hooks/
    ├── grepai-session.mjs          # SessionStart hook
    ├── grepai-reminder.mjs         # PreToolUse:Glob|Grep hook
    └── pre-task.mjs                # PreToolUse:Task hook (grepai injection)
```

---

# ATTENTION SYSTEM (КРИТИЧЕСКИ ВАЖНО)

> Система из 7 точек инъекции, обеспечивающая приоритет grepai над стандартными Glob/Grep.

## Unified Reminder Message

```
grepai: USE grepai_search FIRST for code exploration
```

**Характеристики:**
- Префикс `grepai:` — для категоризации и парсинга
- ALL CAPS `USE...FIRST` — императивная сила
- Точное имя инструмента: `grepai_search`
- Контекст: "for code exploration"

## 7 Injection Points

### Overview Table

| # | Point | Hook/File | Event | Scope | Strength |
|---|-------|-----------|-------|-------|----------|
| 1 | SessionStart | grepai-session.mjs:146 | SessionStart | Session context | MUST |
| 2 | PreToolUse:Task | pre-task.mjs:20,56 | PreToolUse | ALL agents | MUST (prepend) |
| 3 | PreToolUse:Glob/Grep | grepai-reminder.mjs:20 | PreToolUse | Glob/Grep calls | MUST |
| 4 | Rule file | grepai-first.md.template:7 | Always | All files (**/*) | CRITICAL |
| 5 | CLAUDE.md | create-rule.sh:18 | Persistent | Project config | CRITICAL |
| 6 | Root CLAUDE.md | CLAUDE.md:101 | Always | Global | CRITICAL |
| 7 | Agent prompts | pre-task.mjs (prepend) | Every Task | Line 1 of prompt | MUST |

### Injection Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        SESSION START                                      │
│                              │                                            │
│                              ▼                                            │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │ INJECTION POINT #1: grepai-session.mjs (SessionStart)             │   │
│  │                                                                   │   │
│  │  Check: .grepai/ exists? + ollama running? + index.gob exists?    │   │
│  │         │                                                         │   │
│  │         ▼                                                         │   │
│  │  YES → Auto-start watch if needed                                 │   │
│  │         │                                                         │   │
│  │         ▼                                                         │   │
│  │  Inject: additionalContext: "grepai: USE grepai_search FIRST..."  │   │
│  │                                                                   │   │
│  │  Output: systemMessage: "grepai: ready | index: 150MB"            │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                        USER INTERACTION                                   │
│                              │                                            │
│      ┌───────────────────────┼───────────────────────┐                   │
│      │                       │                       │                    │
│      ▼                       ▼                       ▼                    │
│  ┌────────────┐        ┌───────────┐          ┌───────────┐              │
│  │ Task tool  │        │ Glob tool │          │ Grep tool │              │
│  │ (subagent) │        │           │          │           │              │
│  └─────┬──────┘        └─────┬─────┘          └─────┬─────┘              │
│        │                     │                      │                     │
│        ▼                     └──────────┬───────────┘                     │
│  ┌─────────────────┐                    │                                 │
│  │ INJECTION #2    │              ┌─────▼─────────────┐                   │
│  │ pre-task.mjs    │              │ INJECTION #3      │                   │
│  │                 │              │ grepai-reminder   │                   │
│  │ Prepend to ALL  │              │                   │                   │
│  │ agent prompts:  │              │ Inject to context:│                   │
│  │                 │              │ additionalContext │                   │
│  │ "grepai: USE    │              │                   │                   │
│  │  grepai_search  │              │ "grepai: USE..."  │                   │
│  │  FIRST..."      │              │                   │                   │
│  │                 │              │ (reminds about    │                   │
│  │ [original       │              │  alternative)     │                   │
│  │  prompt]        │              │                   │                   │
│  └─────────────────┘              └───────────────────┘                   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                     PERSISTENT INJECTIONS                                 │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │ INJECTION #4: .claude/rules/grepai-first.md                       │   │
│  │                                                                   │   │
│  │  ---                                                              │   │
│  │  paths:                                                           │   │
│  │    - "**/*"                                                       │   │
│  │  description: grepai-first - semantic search FIRST for code      │   │
│  │  ---                                                              │   │
│  │  > **FIRST** `grepai` mcp for code exploration.                   │   │
│  │                                                                   │   │
│  │  | Need | Tool |                                                  │   │
│  │  |------|------|                                                  │   │
│  │  | Explore (semantic) | grepai_search |                           │   │
│  │  | Exact text match   | Grep          |                           │   │
│  │  | File patterns      | Glob          |                           │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │ INJECTION #5: CLAUDE.md (project level, via create-rule.sh)       │   │
│  │                                                                   │   │
│  │  ## Code Search                                                   │   │
│  │  > **CRITICAL:** Use `grepai_search` FIRST for code exploration.  │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │ INJECTION #6: Root CLAUDE.md (plugins/focus-task parent)          │   │
│  │                                                                   │   │
│  │  Line 101: > **CRITICAL:** Use `grepai_search` FIRST for code...  │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### Detailed Injection Mechanisms

#### Injection #1: grepai-session.mjs (SessionStart)

```javascript
// hooks/grepai-session.mjs:143-148
if (status.length === 0) {  // All systems healthy
  hookSpecificOutput.additionalContext =
    'grepai: USE grepai_search FIRST for code exploration';
}
```

**Условия срабатывания:**
- `.grepai/` директория существует
- Ollama запущен (`curl localhost:11434/api/tags`)
- `index.gob` существует
- `grepai watch` процесс активен (или auto-started)

**Output:** systemMessage + additionalContext в начале сессии.

---

#### Injection #2: pre-task.mjs (PreToolUse:Task)

```javascript
// hooks/pre-task.mjs:20
const GREPAI_REMINDER = 'grepai: USE grepai_search FIRST for code exploration';

// hooks/pre-task.mjs:48-59
const grepaiDir = join(cwd, '.grepai');
const hasGrepai = existsSync(grepaiDir);

if (hasGrepai) {
  updatedPrompt = `${GREPAI_REMINDER}\n\n${updatedPrompt}`;
  messages.push('grepai: injected');
}
```

**Scope:** ВСЕ агенты включая системные:
- Explore, Plan, Bash, general-purpose
- developer, tester, reviewer
- ft-coordinator, custom agents

**Mechanism:** Prepending — reminder становится ПЕРВОЙ строкой промпта агента.

**Output structure:**
```javascript
hookSpecificOutput: {
  hookEventName: 'PreToolUse',
  permissionDecision: 'allow',
  updatedInput: {
    ...tool_input,
    prompt: updatedPrompt  // Modified prompt with reminder prepended
  }
}
```

---

#### Injection #3: grepai-reminder.mjs (PreToolUse:Glob|Grep)

```javascript
// hooks/grepai-reminder.mjs:15-22
if (existsSync(grepaiDir)) {
  output({
    hookSpecificOutput: {
      additionalContext: 'grepai: USE grepai_search FIRST for code exploration'
    }
  });
}
```

**Trigger:** Каждый вызов Glob или Grep tool.

**Purpose:** Напоминание о семантической альтернативе при использовании pattern-based поиска.

---

#### Injection #4: grepai-first.md.template (Rule)

```markdown
---
paths:
  - "**/*"
description: grepai-first - semantic search FIRST for code exploration
---

# grepai-first

> **FIRST** `grepai` mcp for code exploration. Params → MCP descriptions.

## When

| Need | Tool | Params |
|------|------|--------|
| Explore (≤5 results) | search | `limit:5` → read content directly |
| Explore (>5 results) | search | `limit:10, compact:true` → then Read |
| Who calls X? | trace_callers | `symbol:"X"` |
| What X calls? | trace_callees | `symbol:"X"` |
| Full dependency tree | trace_graph | `symbol:"X", depth:2` |

**Decision:** "Need exact text/pattern?" → YES: Grep/Glob, NO: grepai
```

**Scope:** Все файлы (`**/*`) via `paths: ["**/*"]`.

---

#### Injection #5 & #6: CLAUDE.md

**Project level (created by create-rule.sh):**
```markdown
## Code Search
> **CRITICAL:** Use `grepai_search` FIRST for code exploration.
```

**Root level (plugins/focus-task/../../CLAUDE.md line 101):**
```markdown
## Code Search
> **CRITICAL:** Use `grepai_search` FIRST for code exploration.
```

---

### Injection #7: Prompt Prepending (Position-Based)

```
Agent receives prompt:
┌─────────────────────────────────────────────────────────────┐
│ Line 1: grepai: USE grepai_search FIRST for code exploration │ ← FIRST
│ Line 2: (empty)                                              │
│ Line 3: [original prompt starts here]                        │
│ Line 4: ...                                                  │
│ Line N: ...                                                  │
└─────────────────────────────────────────────────────────────┘
```

**Why position matters:**
- LLMs обрабатывают текст последовательно
- Первые строки имеют наибольший вес (primacy effect)
- Reminder видится агентом ДО любых инструкций

---

## Attention Strength Escalation

Версия v2.0.57 → v2.0.58 показывает намеренное усиление:

| Version | Message | Strength |
|---------|---------|----------|
| v2.0.57 | `⚠️ consider grepai_search FIRST` | Advisory |
| v2.0.58 | `USE grepai_search FIRST` | Imperative |

**Изменение:** Advisory → Imperative (убрано `⚠️ consider`, добавлено `USE`).

---

## No Opt-Out Design

```
┌────────────────────────────────────────────────────────┐
│            grepai Injection Conditions                  │
│                                                        │
│  ┌──────────────────┐                                  │
│  │ .grepai/ exists? │                                  │
│  └────────┬─────────┘                                  │
│           │                                            │
│      YES  │                                            │
│           ▼                                            │
│  ┌──────────────────────────────────────────────────┐  │
│  │                                                  │  │
│  │  • grepai-session.mjs    → INJECT               │  │
│  │  • pre-task.mjs          → INJECT               │  │
│  │  • grepai-reminder.mjs   → INJECT               │  │
│  │                                                  │  │
│  │  No config to disable. Removal = delete .grepai/│  │
│  │                                                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                        │
│      NO                                                │
│           ▼                                            │
│  ┌──────────────────┐                                  │
│  │ No injection     │                                  │
│  │ (graceful skip)  │                                  │
│  └──────────────────┘                                  │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

# CONTEXT COMPOSITION (Что видит Claude)

> Полный состав контекста и механизм переключения внимания Rule → MCP Tool Descriptions.

## Context Layers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CLAUDE CODE CONTEXT                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ LAYER 1: SYSTEM PROMPT (static per session)                         │   │
│  │                                                                     │   │
│  │  • Base Claude Code instructions                                    │   │
│  │  • Tool definitions (JSON schema for each tool)                     │   │
│  │  • Environment info (cwd, platform, date)                           │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ # MCP Server Instructions                                   │   │   │
│  │  │                                                             │   │   │
│  │  │ The following MCP servers have provided instructions:       │   │   │
│  │  │                                                             │   │   │
│  │  │ ## grepai                                                   │   │   │
│  │  │ Use semantic search for code exploration...                 │   │   │
│  │  │                                                             │   │   │
│  │  │ ## plugin:context7:context7                                 │   │   │
│  │  │ Use this server to retrieve documentation...                │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ LAYER 2: TOOLS ARRAY (function definitions)                         │   │
│  │                                                                     │   │
│  │  {                                                                  │   │
│  │    "name": "mcp__grepai__grepai_search",                           │   │
│  │    "description": "Semantic code search...",     ← FULL DETAILS    │   │
│  │    "parameters": {                                                  │   │
│  │      "query": { "description": "Natural language..." },            │   │
│  │      "limit": { "description": "Maximum results..." },             │   │
│  │      "compact": { "description": "Return minimal JSON..." }        │   │
│  │    }                                                                │   │
│  │  }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ LAYER 3: USER MESSAGES (dynamic per turn)                           │   │
│  │                                                                     │   │
│  │  <system-reminder>                                                  │   │
│  │  Contents of ~/.claude/CLAUDE.md: ...                               │   │
│  │  </system-reminder>                                                 │   │
│  │                                                                     │   │
│  │  <system-reminder>                                                  │   │
│  │  Contents of .claude/rules/grepai-first.md:                         │   │
│  │  > **FIRST** `grepai` mcp for code exploration. Params → MCP...    │   │
│  │  </system-reminder>                                                 │   │
│  │                                                                     │   │
│  │  [User message text]                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ LAYER 4: HOOK INJECTIONS (PreToolUse, SessionStart)                 │   │
│  │                                                                     │   │
│  │  additionalContext: "grepai: USE grepai_search FIRST..."           │   │
│  │  systemMessage: "grepai: ready | index: 150MB"                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Attention Flow: Rule → MCP Tool Descriptions

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     ATTENTION REDIRECTION FLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  USER: "Find authentication code"                                           │
│                    │                                                        │
│                    ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 1: Rule Injection (grepai-first.md)                            │   │
│  │                                                                     │   │
│  │  <system-reminder>                                                  │   │
│  │  > **FIRST** `grepai` mcp for code exploration.                    │   │
│  │  > Params → MCP descriptions.  ←──────────────────────┐            │   │
│  │  </system-reminder>                       REDIRECT    │            │   │
│  └───────────────────────────────────────────────────────│────────────┘   │
│                    │                                     │                  │
│                    ▼                                     │                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 2: Attention Redirects to Tools Array                          │   │
│  │                                     ◄─────────────────┘             │   │
│  │  Claude reads tool definition for `mcp__grepai__grepai_search`:     │   │
│  │                                                                     │   │
│  │  {                                                                  │   │
│  │    "description": "Semantic code search. Search your codebase      │   │
│  │                    using natural language queries...",              │   │
│  │    "parameters": {                                                  │   │
│  │      "query": "Natural language search query (e.g., 'user          │   │
│  │                authentication flow', 'error handling')",            │   │
│  │      "limit": "Maximum number of results (default: 10)",            │   │
│  │      "compact": "Return minimal JSON without content (default: false)"│ │
│  │    }                                                                │   │
│  │  }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                    │                                                        │
│                    ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ STEP 3: Tool Invocation with Correct Params                         │   │
│  │                                                                     │   │
│  │  grepai_search(query="authentication flow", limit=10)               │   │
│  │                                                                     │   │
│  │  ✓ Used natural language (not function name)                        │   │
│  │  ✓ Knew default limit from description                              │   │
│  │  ✓ Understood compact=false means full content                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Why "Params → MCP descriptions" Works

| Component | Location | Content | Token Cost |
|-----------|----------|---------|------------|
| Rule file | `<system-reminder>` | Brief directive | ~50 tokens |
| MCP Tool definition | Tools array | Full param specs | ~200 tokens (already loaded) |
| MCP Server Instructions | System prompt | Server overview | ~100 tokens |

**Design principle:** Rule is a "pointer" — minimal tokens in rule, full details in tool definition that's already in context.

```
Rule (50 tokens):     "Params → MCP descriptions"
                              │
                              ▼
Tool Definition (already in context, 0 extra tokens):
  "query": "Natural language search query..."
  "limit": "Maximum number of results..."
  "compact": "Return minimal JSON..."
```

## MCP Server Instructions Field

MCP servers can provide an `instructions` field that appears in system prompt:

```javascript
// grepai MCP server registration (conceptual)
{
  "name": "grepai",
  "instructions": "Use semantic search for code exploration.
                   Prefer grepai_search over Glob/Grep for understanding code.",
  "tools": [...]
}
```

**Result in system prompt:**
```
# MCP Server Instructions

The following MCP servers have provided instructions:

## grepai
Use semantic search for code exploration...
```

## Complete Injection Points Summary

```
┌────────────────────────────────────────────────────────────────────────┐
│                    ALL INJECTION POINTS                                 │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  SYSTEM PROMPT (Static)                                                │
│  ├─ MCP Server Instructions     ← from MCP server `instructions` field │
│  └─ Tool Definitions            ← from MCP server `tools` array        │
│                                                                        │
│  USER MESSAGES (Dynamic per turn)                                      │
│  ├─ CLAUDE.md                   ← project/global instructions          │
│  ├─ Rules (grepai-first.md)     ← path-specific rules                  │
│  └─ Hook additionalContext      ← grepai-session.mjs, pre-task.mjs     │
│                                                                        │
│  SUBAGENT PROMPTS (Pre-task hook)                                      │
│  └─ Prepended reminder          ← "grepai: USE grepai_search FIRST..." │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

# CONFIGURATION (Reference Only)

## config.yaml Structure

```yaml
version: 1

embedder:
  provider: ollama
  model: bge-m3           # Multilingual, 1024 dims
  endpoint: http://localhost:11434
  dimensions: 1024
  parallelism: 1          # CRITICAL: Always 1 (Ollama limitation)

store:
  backend: gob            # Local file storage

chunking:
  size: 512               # 768-1024 for Java/Kotlin
  overlap: 50             # 75-100 for verbose languages

watch:
  debounce_ms: 500        # 100 (responsive) | 500 (balanced) | 1000 (calm)
  # NEVER include last_index_time — causes skip bug

search:
  boost:
    enabled: true
    penalties:
      - pattern: "**/test/**"           # Tests: 0.5
        factor: 0.5
      - pattern: "**/*Mock*"            # Mocks: 0.4
        factor: 0.4
      - pattern: "**/generated/**"      # Generated: 0.4
        factor: 0.4
    bonuses:
      - pattern: "**/src/main/**"       # Main source: 1.1
        factor: 1.1
      - pattern: "**/core/**"           # Core: 1.2
        factor: 1.2
  hybrid:
    enabled: false                      # true for Java/Kotlin
    k: 60                               # RRF smoothing

trace:
  mode: fast                            # fast (regex) | precise (AST)
  enabled_languages:
    - .java
    - .kt
    - .kts
  exclude_patterns:
    - "*Test.java"
    - "*Spec.kt"

ignore:
  - .git
  - .grepai
  - node_modules
  - vendor
  - dist
  - build
  - target
```

## Language-Specific Defaults

| Setting | Java/Kotlin | JS/TS | Go/Rust | Python |
|---------|-------------|-------|---------|--------|
| chunking.size | 768-1024 | 512 | 256-384 | 512 |
| chunking.overlap | 75-100 | 50 | 30-40 | 50 |
| search.hybrid.enabled | true | false | false | false |
| trace.mode | precise/fast | fast | fast | fast |

## Critical Config Rules

| Rule | Why |
|------|-----|
| `parallelism: 1` | Ollama limitation (https://github.com/ollama/ollama/issues/12591) |
| NO `watch.last_index_time` | Files with ModTime < this are SKIPPED |
| dimensions match model | bge-m3: 1024, nomic: 768 |

## gitignore Behavior

```
┌──────────────────────────────────────────────────────────────┐
│                    gitignore Layers                           │
│                                                              │
│  Layer 1: Global gitignore                                   │
│           ~/.gitignore_global or ~/.config/git/ignore        │
│                         │                                    │
│                         ▼                                    │
│  Layer 2: Local .gitignore                                   │
│           {PROJECT}/.gitignore                               │
│                         │                                    │
│                         ▼                                    │
│  Layer 3: grepai config.yaml ignore:                         │
│           .grepai/config.yaml                                │
│                         │                                    │
│                         ▼                                    │
│  ┌──────────────────────────────────────────────────────┐    │
│  │         FINAL IGNORE SET (ADDITIVE ONLY)             │    │
│  │                                                      │    │
│  │  grepai respects ALL layers combined.               │    │
│  │  Cannot override gitignore via config.              │    │
│  │  No negation patterns (!pattern) supported.         │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  Diagnostic: git check-ignore -v <path>                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

# MCP TOOLS

## Available Tools

| Tool | Parameters | Description |
|------|-----------|-------------|
| `grepai_search` | `query`, `limit`, `compact` | Semantic code search |
| `grepai_trace_callers` | `symbol`, `compact` | Find all callers of symbol |
| `grepai_trace_callees` | `symbol`, `compact` | Find all callees of symbol |
| `grepai_trace_graph` | `symbol`, `depth`, `compact` | Build call graph |
| `grepai_index_status` | `verbose` | Check index health |

## Compact Mode (80% Token Reduction)

```json
// Normal response
{
  "query": "authentication flow",
  "results": [
    {
      "score": 0.92,
      "file": "src/auth/LoginService.java",
      "lines": "15-45",
      "content": "public class LoginService..."
    }
  ],
  "total": 1
}

// Compact response
{"q":"auth","r":[{"s":0.92,"f":"src/auth.go","l":"15-45"}],"t":1}
```

**Key mapping:** q=query, r=results, s=score, f=file, l=lines, t=total

## MCP Configuration

**.mcp.json (project) or ~/.claude.json (global):**
```json
{
  "mcpServers": {
    "grepai": {
      "command": "grepai",
      "args": ["mcp-serve"],
      "cwd": "/path/to/project"
    }
  }
}
```

**CLI:** `claude mcp add grepai -- grepai mcp-serve`

## Permissions (allowedTools)

**~/.claude/settings.json:**
```json
{
  "allowedTools": ["mcp__grepai__*"]
}
```

**Why needed:** MCP tools marked `[destructive]` by default. All grepai tools are read-only.

---

# SKILL: /focus-task:grepai

## Modes

| Mode | Trigger | Purpose |
|------|---------|---------|
| `setup` | setup, install, configure, init | Full installation |
| `status` | status, doctor, check, health | Health check |
| `start` | start, watch | Start watcher daemon |
| `stop` | stop, halt, kill | Stop watcher |
| `reindex` | reindex, rebuild, refresh | Full index rebuild |
| `optimize` | optimize, update | Regenerate config |
| `upgrade` | upgrade, brew | Update CLI via Homebrew |

## Scripts

| Script | Purpose |
|--------|---------|
| detect-mode.sh | Parse args, determine mode |
| infra-check.sh | Verify grepai/Ollama/bge-m3 |
| mcp-check.sh | Configure MCP + permissions |
| init-index.sh | Build index (sync) |
| start.sh | Start watch daemon |
| stop.sh | Stop watch daemon |
| reindex.sh | Full rebuild |
| optimize.sh | Backup config |
| upgrade.sh | Homebrew upgrade |
| status.sh | Health check |
| verify.sh | Test search |
| create-rule.sh | Generate grepai-first.md |

---

# AGENT: ft-grepai-configurator

**Model:** Opus 4.5 | **Type:** Subagent | **Permission:** acceptEdits

## Workflow

```
Phase 1: Infrastructure Check
  ├─ Verify grepai binary
  ├─ Verify Ollama
  └─ Verify bge-m3 model

Phase 2: Parallel Project Analysis (5 Explore agents)
  ├─ LANGUAGES — build files (pom.xml, package.json, go.mod)
  ├─ TEST PATTERNS — test directories
  ├─ GENERATED CODE — codegen patterns
  ├─ SOURCE STRUCTURE — main directories
  └─ IGNORE PATTERNS — gitignore analysis

Phase 3: Generate Config
  └─ Create .grepai/config.yaml

Phase 4: MCP Integration
  └─ Configure Claude Code access

Phase 5: Verification
  └─ Test search, check index
```

---

# EMBEDDER MODELS

| Model | Dims | Size | RAM | Speed | Quality | Use Case |
|-------|------|------|-----|-------|---------|----------|
| bge-m3 | 1024 | 1.2GB | ~1.5GB | ⚡ | ⭐⭐⭐⭐⭐ | Multilingual (default) |
| mxbai-embed-large | 1024 | 670MB | ~1GB | ⚡⚡ | ⭐⭐⭐⭐⭐ | English-only, max accuracy |
| nomic-embed-text-v2-moe | 768 | 500MB | ~800MB | ⚡⚡ | ⭐⭐⭐⭐ | 100+ langs, lightweight |
| nomic-embed-text | 768 | 274MB | ~500MB | ⚡⚡⚡ | ⭐⭐⭐ | Fast, small projects |

---

# INDEXING TIME

| Files | Time |
|-------|------|
| <100 | ~30s |
| ~1,000 | ~5 min |
| ~10,000 | ~30 min |

---

# QUERY TIPS

| Do | Don't |
|----|-------|
| English | Russian/other langs |
| 3-7 words | Single word |
| Intent: "user authentication flow" | Syntax: "validateUser()" |
| Specific: "handles login errors" | Vague: "error handling" |

---

# TROUBLESHOOTING

| Issue | Solution |
|-------|----------|
| Files not indexed | `git check-ignore -v <path>` |
| Index outdated | `/focus-task:grepai reindex` |
| Ollama not running | `ollama serve` |
| Watch not starting | Check `.grepai/logs/grepai-watch.log` |
| Slow indexing | Check `parallelism: 1` in config |
| Poor search quality | Adjust `chunking.size` for language |
